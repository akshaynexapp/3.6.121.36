{% load leaflet_tags i18n %}
{% load i18n %}
{% load static %}
<script type="text/javascript">
  window._owGeoMapConfig = {
    geoJsonUrl: '{{ monitoring_location_geojson_url }}',
    locationDeviceUrl: '{{ monitoring_device_list_url }}?page_size=5'
  }
</script>
<script type="text/javascript" src={%static 'monitoring/js/lib/netjsongraph.min.js' %}></script>
<script type="text/javascript" src={%static 'monitoring/js/lib/leaflet.fullscreen.min.js' %}></script>
<div id='leaflet-config'>
  {% autoescape on %}{% leaflet_json_config %}{% endautoescape %}
</div>


<div id="device-map-container">
  <div class="no-data">
    <p>{% trans 'No map data to show' %}.</p>
    <p><a class="button submit" href="#close">Close</a></p>
  </div>
  <div class="ow-loading-spinner"></div>
</div>

{% comment %} Cards Online Offline (NexappController<>)  {% endcomment %}

<div id="card-div" class="cards">
  {% comment %} <h1>Cards</h1> {% endcomment %}
  <div class="card">
    <h2>Total Devices</h2>
    <p id="total-devices">Loading...</p>
  </div>
  <div class="card">
    <h2>Online Devices</h2>
    <p id="monitoring-ok">Loading...</p>
  </div>
  <div class="card">
    <h2>Offline Devices</h2>
    <p id="monitoring-critical">Loading...</p>
  </div>
</div>

<script>
  async function fetchAuthToken() {
    try {
      const response = await fetch('https://3.6.121.36/api/v1/users/token/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
          'username': 'admin',
          'password': 'Nexapp@123'
        }),
        mode: 'cors'
      });

      const data = await response.json();
      return data.token;
    } catch (error) {
      console.error('Token fetch failed:', error);
      return null;
    }
  }

  async function fetchDeviceData() {
    const token = await fetchAuthToken();
    if (!token) {
      document.getElementById('total-devices').innerText = 'Auth error';
      document.getElementById('monitoring-ok').innerText = 'Auth error';
      document.getElementById('monitoring-critical').innerText = 'Auth error';
      return;
    }

    try {
      const response = await fetch('https://3.6.121.36/api/v1/controller/device/', {
        headers: {
          'accept': 'application/json',
          'Authorization': `Token ${token}`
        }
      });

      const data = await response.json();

      // Update total device count
      document.getElementById('total-devices').innerText = data.count;

      // Extract UUIDs and check monitoring status for each device
      const uuids = data.results.map(device => device.id);

      let okStatusCount = 0;
      let criticalStatusCount = 0;

      const statusChecks = uuids.map(async (uuid) => {
        const res = await fetch(`https://3.6.121.36/api/v1/monitoring/device/${uuid}/`, {
          headers: {
            'accept': 'application/json',
            'Authorization': `Token ${token}`
          }
        });
        const deviceStatus = await res.json();
        if (deviceStatus.monitoring && deviceStatus.monitoring.status === 'ok') {
          okStatusCount++;
        } else if (deviceStatus.monitoring && deviceStatus.monitoring.status === 'critical') {
          criticalStatusCount++;
        }
      });

      await Promise.all(statusChecks);
      document.getElementById('monitoring-ok').innerText = `${okStatusCount}`;
      document.getElementById('monitoring-critical').innerText = `${criticalStatusCount}`;

    } catch (error) {
      console.error('Error fetching device data:', error);
      document.getElementById('total-devices').innerText = 'Error';
      document.getElementById('monitoring-ok').innerText = 'Error';
      document.getElementById('monitoring-critical').innerText = 'Error';
    }
  }

  // Trigger on page load
  fetchDeviceData();
</script>

<style>
  .cards {
    display: flex;
    gap: 2rem;
    margin-top: 1rem;
    margin-left:10rem
  }
  .card {
    padding: 1rem;
    border: 1px solid #ccc;
    border-radius: 10px;
    background: #f9f9f9;
    width: 200px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .card h2 {
    margin-bottom: 0.5rem;
  }
</style>